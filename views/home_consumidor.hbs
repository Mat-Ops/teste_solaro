<!DOCTYPE html>
<html lang="pt-BR">
{{> head }}

<body>
    <!-- Navbar -->
    <header class="custom-header">
        {{> navbar_home }}
    </header>
    <br />

    <!-- Seção Principal -->
    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-4">Bem-vindo, {{nomeFornecedor}}!</h2>
            <p class="text-center mb-5">
                Gerencie suas economias e acompanhe seu desempenho na plataforma.
            </p>

            {{#if dataAssinatura}}
            <!-- Dashboard -->
            <div class="row g-4 justify-content-center text-center">
                <div class="col-md-4">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-primary">Consumo Médio Mensal</h5>
                        <p class="display-5 fw-bold">{{consumo_medio}} kWh</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-success">Valor Médio das Contas</h5>
                        <p class="display-5 fw-bold">R$ {{valor_medio_contas}}</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm p-4 card-dashboard">
                        <h5 class="text-warning">Economia Estimada</h5>
                        <p class="display-5 fw-bold">R$ {{economia_estimada}}</p>
                    </div>
                </div>
            </div>

            {{else}}
            <!-- Simulador -->
            <section class="my-5 border-simulador">
                <h4 class="mb-4 text-center">Simule sua Economia</h4>
                <form id="simuladorForm" method="POST" action="/Simular-Contrato">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                Consumo de kWh nos 3 últimos meses:

                                <!-- Ícone com tooltip -->
                                <!-- Ícone com Tooltip -->
                                <i class="bi bi-info-circle-fill text-primary"
                                    id="tooltipIcon"
                                    style="cursor: pointer;"
                                    data-bs-toggle="tooltip"
                                    data-bs-html="true"
                                    title="">
                                </i>

                            </label>

                            <input type="number" class="form-control mb-2" id="kwh1" placeholder="Mês 1 (kWh)" required>
                            <input type="number" class="form-control mb-2" id="kwh2" placeholder="Mês 2 (kWh)" required>
                            <input type="number" class="form-control" id="kwh3" placeholder="Mês 3 (kWh)" required>
                        </div>


                        <div class="col-md-6">
                            <label class="form-label">Valor das 3 últimas contas (R$):</label>
                            <input type="number" class="form-control mb-2" id="conta1" placeholder="Valor Conta 1 (R$)" required>
                            <input type="number" class="form-control mb-2" id="conta2" placeholder="Valor Conta 2 (R$)" required>
                            <input type="number" class="form-control" id="conta3" placeholder="Valor Conta 3 (R$)" required>
                        </div>


                        <div class="col-md-12">
                            <label for="resultado_calculado" class="form-label">Valor Mensal com Taxa</label>
                            <!-- MUDAR -->
                            <input type="text" class="form-control bg-light" id="resultado_calculado"
                                name="resultado_calculado" value="{{resultado_calculado}}" readonly>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-primary px-4 py-2">
                            <i class="bi bi-calculator-fill me-2"></i>Simular Oferta
                        </button>
                    </div>
                </form>
            </section>
        </div>


        <!-- Espaço -->
        <div style="height: 30px;"></div>

        <!-- Botão abre Modal -->
        <section class="d-flex justify-content-center align-items-center mt-5">
            <div class="text-center">
                <button
                    class="btn btn-outline-primary btn-lg px-5 py-3 shadow-sm fw-bold animate__animated animate__pulse animate__infinite"
                    data-bs-toggle="modal" data-bs-target="#modalOferta">
                    <i class="bi bi-plus-circle me-2"></i> Cadastrar Nova Oferta
                </button>
                <p class="mt-2 text-muted small">Solicite uma nova oferta de energia solar personalizada para você.</p>
            </div>
        </section>

        {{/if}}



        </div>
    </section>

    <!-- Modal de Cadastro de Oferta -->
    <div class="modal fade" id="modalOferta" tabindex="-1" aria-labelledby="modalOfertaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" action="/cadastro_oferta">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalOfertaLabel">Cadastrar Nova Oferta</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="mb-3">
                            <label class="form-label">Consumo de kWh nos 3 últimos meses:</label>
                            <input type="number" class="form-control mb-2" id="kwh1" placeholder="Mês 1 (kWh)" required>
                            <input type="number" class="form-control mb-2" id="kwh2" placeholder="Mês 2 (kWh)" required>
                            <input type="number" class="form-control" id="kwh3" placeholder="Mês 3 (kWh)" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Valor das 3 últimas contas (R$):</label>
                            <input type="number" class="form-control mb-2" id="conta1" placeholder="Valor Conta 1 (R$)" required>
                            <input type="number" class="form-control mb-2" id="conta2" placeholder="Valor Conta 2 (R$)" required>
                            <input type="number" class="form-control" id="conta3" placeholder="Valor Conta 3 (R$)" required>
                        </div>

                        <div class="border rounded p-3 bg-light mb-3">
                            <h6 class="text-center fw-bold">Contrato de Parceria com a SOLARO</h6>
                            <ul class="small">
                                <li>A energia que você consumir será fornecida por parceiros cadastrados na plataforma
                                    SOLARO, garantindo transparência e segurança.</li>
                                <li>Os fornecedores recebem o pagamento pela energia vendida, descontada uma taxa
                                    administrativa que cobre os serviços da plataforma.</li>
                                <li>O contrato começa a valer a partir da assinatura e tem duração conforme o período
                                    acordado, encerrando-se automaticamente ao final.</li>
                                <li>Os pagamentos aos fornecedores são realizados mensalmente, após a confirmação do
                                    consumo registrado.</li>
                                <li>Os fornecedores se comprometem a manter a geração de energia conforme as ofertas
                                    cadastradas, assegurando a entrega do serviço contratado.</li>
                            </ul>

                        </div>


                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="aceiteContrato" name="aceite_contrato"
                                required>
                            <label class="form-check-label" for="aceiteContrato">
                                Eu li e aceito os termos do contrato com a plataforma SOLARO.
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Cadastrar Oferta e Assinar Contrato</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Seção de Contrato Ativo -->
    {{#if dataAssinatura}}
    <section class="container my-5">
        <div class="card border-start border-4 shadow-sm p-4 oferta-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="oferta-titulo mb-1">Contrato Ativo</h4>
                    <small class="oferta-subtitulo">Parceria com a plataforma SOLARO</small>
                </div>
                <button class="btn oferta-btn-outline-primary" data-bs-toggle="modal"
                    data-bs-target="#modalVisualizarContrato">
                    <i class="bi bi-file-earmark-text me-2"></i>Ver Detalhes
                </button>
            </div>

            <div class="row text-center text-md-start">
                <div class="col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong><i class="bi bi-calendar-check me-2"></i>Assinatura:</strong></p>
                    <p>{{dataAssinatura}}</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <p class="mb-1"><strong><i class="bi bi-calendar-x me-2"></i>Validade:</strong></p>
                    <p>até {{dataFinal}}</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong><i class="bi bi-clock me-2"></i>Duração:</strong></p>
                    <p>{{prazoContrato}} meses</p>
                </div>
            </div>
        </div>
    </section>
    {{/if}}

    <!-- Modal de Visualização -->
    <div class="modal fade" id="modalVisualizarContrato" tabindex="-1" aria-labelledby="visualizarContratoLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header oferta-bg-primary text-white">
                    <h5 class="modal-title" id="visualizarContratoLabel"><i
                            class="bi bi-file-earmark-text me-2"></i>Contrato de
                        Parceria com a SOLARO</h5>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <dl class="row">
                        <dt class="col-sm-4">consumidor</dt>
                        <dd class="col-sm-8">{{nomeFornecedor}}</dd>

                        <dt class="col-sm-4">Estado do consumidor</dt>
                        <dd class="col-sm-8">{{estado_fazenda}}</dd>

                        <dt class="col-sm-4">Média de consumo de kWh</dt>
                        <dd class="col-sm-8">R$ {{preco_kwh}}</dd>

                        <dt class="col-sm-4">Média de valor de contas</dt>
                        <dd class="col-sm-8">{{geracao_kwh}} kWh</dd>

                        <dt class="col-sm-4">Data de Início</dt>
                        <dd class="col-sm-8">{{dataAssinatura}}</dd>

                        <dt class="col-sm-4">Data de Término</dt>
                        <dd class="col-sm-8">{{dataFinal}}</dd>
                    </dl>
                    <hr>
                    <p class="small">
                        Este contrato estabelece os termos de parceria entre o consumidor {{nomeFornecedor}} e a
                        plataforma SOLARO
                        Marketplace.

                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" data-bs-toggle="modal"
                        data-bs-target="#modalAvisoMulta">
                        Rescindir Contrato
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Rescindir Contrato -->
    <div class="modal fade" id="modalAvisoMulta" tabindex="-1" aria-labelledby="modalAvisoMultaLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="modalAvisoMultaLabel">Aviso de Multa</h5>
                </div>
                <div class="modal-body">
                    Ao rescindir o contrato, será aplicada uma multa proporcional ao prazo restante. Deseja continuar?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <form id="rescindir" action="/rescindir_contrato" method="POST">
                        <button type="submit" class="btn btn-danger">Confirmar Rescisão</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Dicas -->
    <section class="py-5 bg-white">
        <div class="container">
            <h3 class="mb-4">Dicas para economizar energia e reduzir sua conta</h3>
            <ul>
                <li>Monitore seu consumo regularmente para identificar desperdícios</li>
                <li>Opte por horários de menor tarifa para usar aparelhos de maior consumo</li>
                <li>Invista em aparelhos eficientes e que economizam energia</li>
                <li>Mantenha seu sistema elétrico revisado para evitar perdas e falhas</li>
            </ul>
        </div>

    </section>

    <!-- Espaço -->
    <div style="height: 100px;"></div>

    <!-- Footer -->
    {{> footer }}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            fetch('/api/estados')
                .then(response => response.json())
                .then(estados => {
                    const selects = document.querySelectorAll('select.uf-select');
                    selects.forEach(select => {
                        estados.forEach(estado => {
                            const option = document.createElement('option');
                            option.value = estado.sigla;
                            option.textContent = `${estado.nome} (${estado.sigla})`;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar estados:', error);
                });
        });

    </script>


</body>

</html>