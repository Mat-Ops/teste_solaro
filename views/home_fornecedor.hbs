<!DOCTYPE html>
<html lang="pt-BR">
{{> head }}

<body>
  <!-- Navbar -->
  <header class="custom-header">
    {{> navbar_home }}
  </header>
  <br />

  <!-- Seção Principal -->
  <section class="py-5 bg-light">
    <div class="container">
      <h2 class="text-center mb-4">Bem-vindo, {{nomeFornecedor}}!</h2>
      <p class="text-center mb-5">
        Gerencie suas ofertas e acompanhe seu desempenho na plataforma.
      </p>

      {{#if dataAssinatura}}
      <!-- Dashboard -->
      <div class="row g-4 justify-content-center text-center">
        <div class="col-md-6">
          <div class="card shadow-sm p-4 card-dashboard">
            <h5 class="text-warning">Preço do kWh</h5>
            <p class="display-6 fw-bold">R$ {{preco_kwh}}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm p-4 card-dashboard">
            <h5 class="text-warning">Geração por Hora</h5>
            <p class="display-6 fw-bold">{{geracao_kwh}} KWh</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm p-4 card-dashboard">
            <h5 class="text-success">Energia Total</h5>
            <p class="display-6 fw-bold">{{kwh_total}} kWh</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm p-4 card-dashboard border-danger">
            <h5 class="text-danger">A Receber</h5>
            <p class="display-6 fw-bold">R$ {{repasse}}</p>
          </div>
        </div>
      </div>

      {{else}}
      <!-- Simulador -->
      <section class="my-5">
                <h4 class="mb-4 text-center">Simule sua Oferta</h4>

      <form id="simuladorForm" method="POST" action="/Simular-Contrato">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="preco_kwh_sim" class="form-label">Preço do kWh (R$)</label>
            <input type="number" step="0.01" class="form-control" id="preco_kwh_sim" name="preco_kwh_sim" required>
          </div>

          <div class="col-md-6">
            <label for="geracao_kwh_sim" class="form-label">Geração por Hora (kWh)</label>
            <input type="number" step="0.01" class="form-control" id="geracao_kwh_sim" name="geracao_kwh_sim" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Prazo de Contrato</label>
            <select class="form-select" name="prazo_contrato_sim" required>
              <option value="" disabled selected>Selecione um prazo</option>
              <option value="3">3 meses - Taxa SOLARO: 7,5%</option>
              <option value="6">6 meses - Taxa SOLARO: 5%</option>
              <option value="12">1 ano - Taxa SOLARO: 2,5%</option>
            </select>
          </div>

          <div class="col-md-6">
            <label for="estado_fazenda_sim" class="form-label">Estado da Fazenda</label>
            <select class="form-select" id="estado_fazenda_sim" name="estado_fazenda_sim" required>
              <option value="" disabled selected>Selecione o estado (UF)</option>
              <option value="AC">Acre (AC)</option>
              <option value="AL">Alagoas (AL)</option>
              <option value="AP">Amapá (AP)</option>
              <option value="AM">Amazonas (AM)</option>
              <option value="BA">Bahia (BA)</option>
              <option value="CE">Ceará (CE)</option>
              <option value="DF">Distrito Federal (DF)</option>
              <option value="ES">Espírito Santo (ES)</option>
              <option value="GO">Goiás (GO)</option>
              <option value="MA">Maranhão (MA)</option>
              <option value="MT">Mato Grosso (MT)</option>
              <option value="MS">Mato Grosso do Sul (MS)</option>
              <option value="MG">Minas Gerais (MG)</option>
              <option value="PA">Pará (PA)</option>
              <option value="PB">Paraíba (PB)</option>
              <option value="PR">Paraná (PR)</option>
              <option value="PE">Pernambuco (PE)</option>
              <option value="PI">Piauí (PI)</option>
              <option value="RJ">Rio de Janeiro (RJ)</option>
              <option value="RN">Rio Grande do Norte (RN)</option>
              <option value="RS">Rio Grande do Sul (RS)</option>
              <option value="RO">Rondônia (RO)</option>
              <option value="RR">Roraima (RR)</option>
              <option value="SC">Santa Catarina (SC)</option>
              <option value="SP">São Paulo (SP)</option>
              <option value="SE">Sergipe (SE)</option>
              <option value="TO">Tocantins (TO)</option>
              {{#each estados}}
              <option value="{{this.sigla}}">{{this.nome}} ({{this.sigla}})</option>
              {{/each}}
            </select>
          </div>

          <div class="col-md-12">
            <label for="resultado_calculado" class="form-label">Valor Mensal com Taxa</label>
            <input type="text" class="form-control bg-light" id="resultado_calculado" name="resultado_calculado"
              value="{{resultado_calculado}}" readonly>
          </div>
        </div>

        <div class="d-flex justify-content-center mt-4">
          <button type="submit" class="btn btn-primary px-4 py-2">
            <i class="bi bi-calculator-fill me-2"></i>Simular Oferta
          </button>
        </div>
      </form>
      </section>

    </div>

    </div>

    <script>
      function calcularVenda() {
        const precoKwh = parseFloat(document.getElementById('preco_kwh_sim').value);
        const geracaoKwh = parseFloat(document.getElementById('geracao_kwh_sim').value);

        const prazoContrato = document.querySelector('select[name="prazo_contrato_sim"]').value;
        const estadoFazenda = document.getElementById('estado_fazenda_sim').value;

        if (
          isNaN(precoKwh) ||
          isNaN(geracaoKwh) ||
          !prazoContrato ||
          !estadoFazenda
        ) {
          Swal.fire({
            title: "Preencha os campos faltantes",
            icon: "error",
            draggable: true
          });
          return;
        }

        console.log("Preço do kWh:", precoKwh);
        console.log("Geração por Hora:", geracaoKwh);
        console.log("Prazo de Contrato:", prazoContrato);
        console.log("Estado da Fazenda:", estadoFazenda);



      }
    </script>

    <!-- Espaço -->
    <div style="height: 100px;"></div>

    <!-- Botão abre Modal -->
    <section class="d-flex justify-content-center align-items-center mt-5">
      <div class="text-center">
        <button
          class="btn btn-outline-primary btn-lg px-5 py-3 shadow-sm fw-bold animate__animated animate__pulse animate__infinite"
          data-bs-toggle="modal" data-bs-target="#modalOferta">
          <i class="bi bi-plus-circle me-2"></i> Cadastrar Nova Oferta
        </button>
        <p class="mt-2 text-muted small">Inicie uma nova parceria com a plataforma SOLARO</p>
      </div>
    </section>

    {{/if}}



    </div>
  </section>

  <!-- Modal de Cadastro de Oferta -->
  <div class="modal fade" id="modalOferta" tabindex="-1" aria-labelledby="modalOfertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" action="/cadastro_oferta">
          <div class="modal-header">
            <h5 class="modal-title" id="modalOfertaLabel">Cadastrar Oferta de Energia</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div class="mb-3">
              <label for="preco_kwh" class="form-label">Preço do kWh (R$)</label>
              <input type="number" step="0.01" class="form-control" id="preco_kwh" name="preco_kwh" required>
            </div>

            <div class="mb-3">
              <label for="geracao_kwh" class="form-label">Geração por Hora (kWh)</label>
              <input type="number" step="0.01" class="form-control" id="geracao_kwh" name="geracao_kwh" required>
            </div>

            <div class="mb-3">
              <label for="estado_fazenda" class="form-label">Estado da Fazenda de Energia</label>
              <select class="form-select" id="estado_fazenda" name="estado_fazenda" required>
                <option value="" selected disabled>Selecione o estado (UF)</option>
                <option value="AC">Acre (AC)</option>
                <option value="AL">Alagoas (AL)</option>
                <option value="AP">Amapá (AP)</option>
                <option value="AM">Amazonas (AM)</option>
                <option value="BA">Bahia (BA)</option>
                <option value="CE">Ceará (CE)</option>
                <option value="DF">Distrito Federal (DF)</option>
                <option value="ES">Espírito Santo (ES)</option>
                <option value="GO">Goiás (GO)</option>
                <option value="MA">Maranhão (MA)</option>
                <option value="MT">Mato Grosso (MT)</option>
                <option value="MS">Mato Grosso do Sul (MS)</option>
                <option value="MG">Minas Gerais (MG)</option>
                <option value="PA">Pará (PA)</option>
                <option value="PB">Paraíba (PB)</option>
                <option value="PR">Paraná (PR)</option>
                <option value="PE">Pernambuco (PE)</option>
                <option value="PI">Piauí (PI)</option>
                <option value="RJ">Rio de Janeiro (RJ)</option>
                <option value="RN">Rio Grande do Norte (RN)</option>
                <option value="RS">Rio Grande do Sul (RS)</option>
                <option value="RO">Rondônia (RO)</option>
                <option value="RR">Roraima (RR)</option>
                <option value="SC">Santa Catarina (SC)</option>
                <option value="SP">São Paulo (SP)</option>
                <option value="SE">Sergipe (SE)</option>
                <option value="TO">Tocantins (TO)</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="form-label">Prazo de Contrato</label>
              <select class="form-select" name="prazo_contrato" required>
                <option value="" disabled selected>Selecione um prazo</option>
                <option value="3_meses">3 meses - Taxa SOLARO: 7,5%</option>
                <option value="6_meses">6 meses - Taxa SOLARO: 5%</option>
                <option value="12_meses">1 ano - Taxa SOLARO: 2,5%</option>
              </select>
            </div>

            <div class="border rounded p-3 bg-light mb-3">
              <h6 class="text-center fw-bold">Contrato de Parceria com a SOLARO</h6>
              <ul class="small">
                <li>A energia gerada será ofertada a consumidores pela plataforma SOLARO.</li>
                <li>O fornecedor receberá os valores referentes à energia vendida, descontada a taxa
                  administrativa.
                </li>
                <li>Contrato inicia na assinatura e termina automaticamente após o prazo.</li>
                <li>Pagamentos são repassados mensalmente após o fechamento de consumo.</li>
                <li>Fornecedor deve manter a geração conforme informado na oferta.</li>
              </ul>
            </div>

            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="aceiteContrato" name="aceite_contrato" required>
              <label class="form-check-label" for="aceiteContrato">
                Eu li e aceito os termos do contrato com a plataforma SOLARO.
              </label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Cadastrar Oferta e Assinar Contrato</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Seção de Contrato Ativo -->
  {{#if dataAssinatura}}
  <section class="container my-5">
    <div class="card border-start border-4 shadow-sm p-4 oferta-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="oferta-titulo mb-1">Contrato Ativo</h4>
          <small class="oferta-subtitulo">Parceria com a plataforma SOLARO</small>
        </div>
        <button class="btn oferta-btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalVisualizarContrato">
          <i class="bi bi-file-earmark-text me-2"></i>Ver Detalhes
        </button>
      </div>

      <div class="row text-center text-md-start">
        <div class="col-md-4 mb-3 mb-md-0">
          <p class="mb-1"><strong><i class="bi bi-calendar-check me-2"></i>Assinatura:</strong></p>
          <p>{{dataAssinatura}}</p>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <p class="mb-1"><strong><i class="bi bi-calendar-x me-2"></i>Validade:</strong></p>
          <p>até {{dataFinal}}</p>
        </div>
        <div class="col-md-4">
          <p class="mb-1"><strong><i class="bi bi-clock me-2"></i>Duração:</strong></p>
          <p>{{prazoContrato}} meses</p>
        </div>
      </div>
    </div>
  </section>
  {{/if}}

  <!-- Modal de Visualização -->
  <div class="modal fade" id="modalVisualizarContrato" tabindex="-1" aria-labelledby="visualizarContratoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header oferta-bg-primary text-white">
          <h5 class="modal-title" id="visualizarContratoLabel"><i class="bi bi-file-earmark-text me-2"></i>Contrato de
            Parceria com a SOLARO</h5>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <dl class="row">
            <dt class="col-sm-4">Fornecedor</dt>
            <dd class="col-sm-8">{{nomeFornecedor}}</dd>

            <dt class="col-sm-4">Estado da Fazenda</dt>
            <dd class="col-sm-8">{{estado_fazenda}}</dd>

            <dt class="col-sm-4">Preço kWh</dt>
            <dd class="col-sm-8">R$ {{preco_kwh}}</dd>

            <dt class="col-sm-4">Geração por Hora</dt>
            <dd class="col-sm-8">{{geracao_kwh}} kWh</dd>

            <dt class="col-sm-4">Prazo</dt>
            <dd class="col-sm-8">{{prazoContrato}} meses</dd>

            <dt class="col-sm-4">Data de Início</dt>
            <dd class="col-sm-8">{{dataAssinatura}}</dd>

            <dt class="col-sm-4">Data de Término</dt>
            <dd class="col-sm-8">{{dataFinal}}</dd>
          </dl>
          <hr>
          <p class="small">
            Este contrato estabelece os termos de parceria entre o fornecedor {{nomeFornecedor}} e a
            plataforma SOLARO
            Marketplace.

          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" data-bs-toggle="modal" data-bs-target="#modalAvisoMulta">
            Rescindir Contrato
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Rescindir Contrato -->
  <div class="modal fade" id="modalAvisoMulta" tabindex="-1" aria-labelledby="modalAvisoMultaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="modalAvisoMultaLabel">Aviso de Multa</h5>
        </div>
        <div class="modal-body">
          Ao rescindir o contrato, será aplicada uma multa proporcional ao prazo restante. Deseja continuar?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <form id="rescindir" action="/rescindir_contrato" method="POST">
            <button type="submit" class="btn btn-danger">Confirmar Rescisão</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Dicas -->
  <section class="py-5 bg-white">
    <div class="container">
      <h3 class="mb-4">Dicas para aumentar suas vendas</h3>
      <ul>
        <li>Mantenha suas ofertas sempre atualizadas</li>
        <li>Ofereça preços e condições competitivas</li>
      </ul>
    </div>
  </section>

  <!-- Espaço -->
  <div style="height: 100px;"></div>

  <!-- Footer -->
  {{> footer }}

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>

    document.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById('modalOferta');
      const form = modal.querySelector("form");

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Contrato Realizado com Sucesso!",
          icon: "success",
          confirmButtonText: "OK"
        }).then(() => {
          form.submit();
        });
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("rescindir");

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        Swal.fire({
          icon: "warning",
          title: "Tem certeza?",
          text: "Você está prestes a rescindir o contrato. Deseja continuar?",
          showCancelButton: true,
          confirmButtonText: "Sim, confirmar!",
          cancelButtonText: "Cancelar"
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              icon: "success",
              title: "Contrato Anulado!",
              text: "As informações foram enviadas para seu e-mail.",
              timer: 2000,
              showConfirmButton: false
            });
            setTimeout(() => {
              form.submit();
            }, 2000);
          }
        });
      });
    });
  </script>
</body>

</html>